{% extends 'base.html' %}
{% block title %}Dashboard - Social Automator{% endblock %}

{% block content %}
    <div class="page-intro">
        <h2>Dashboard</h2>
        <p>Welcome to your Social Automator dashboard. Generate, manage, and post your content from one place.</p>
    </div>

    <div class="dashboard-grid">
        <div class="card">
            <h3>Generate from CSV</h3>
            <form action="{{ url_for('upload_csv') }}" method="post" enctype="multipart/form-data">
                <div class="form-group">
                    <label for="file">1. Upload CSV Data File</label>
                    <div class="file-input-container">
                        <input type="file" name="file" id="file" class="inputfile" required onchange="updateFileName(this)">
                        <label for="file" class="btn">Choose a file&hellip;</label>
                        <span id="file-name-display" class="file-name-display">No file chosen</span>
                    </div>
                    <small class="form-text">Don't have a template? <a href="{{ url_for('download_template') }}">Download sample</a>.</small>
                </div>
                <div class="form-group">
                    <label for="template">2. Choose HTML Template</label>
                    <div class="select-wrapper">
                        <select name="template" id="template" required>
                            {% for template in templates %}
                                <option value="{{ template }}">{{ template.replace('template_', '').replace('.html', '')|replace('_', ' ')|title }}</option>
                            {% else %}
                                <option>No templates found.</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <button type="submit" class="btn btn-primary">Generate Thumbnails</button>
                </div>
            </form>
        </div>

        <div class="card">
            <h3>Quick Actions</h3>
            <div class="quick-actions">
                <a href="{{ url_for('manual_entry') }}" class="btn">Manual Entry</a>
                <a href="{{ url_for('manage_templates') }}" class="btn">Template Editor</a>
                <a href="{{ url_for('settings') }}" class="btn">Settings</a>
            </div>
        </div>

        <div class="card">
            <h3>Bulk Actions</h3>
            <div class="quick-actions">
                <form action="{{ url_for('spin_images') }}" method="post" onsubmit="return confirm('This will randomly change all thumbnail images. Are you sure?')">
                    <button type="submit" class="btn">Image Spinner</button>
                </form>
            </div>
        </div>
    </div>

    <div class="card" id="gallery">
        <h2>Generated Thumbnails</h2>
        {% if thumbnails %}
            <div class="gallery-actions">
                <a href="{{ url_for('download_all') }}" class="btn">Download All as ZIP</a>
            </div>
            <div class="gallery">
                {% for thumbnail in thumbnails %}
                <div class="thumbnail-card">
                    <div class="thumbnail-image">
                         <img src="{{ url_for('generated_file', filename=thumbnail.filename) }}?v={{ range(9999) | random }}" alt="Thumbnail {{ thumbnail.id }}" loading="lazy">
                    </div>
                    <div class="thumbnail-footer">
                        <div class="swap-form">
                            <form action="{{ url_for('swap_template', thumbnail_id=thumbnail.id) }}" method="post" class="swap-form-flex">
                                <div class="select-wrapper">
                                    <select name="new_template">
                                        {% for t in templates %}
                                            <option value="{{ t }}" {% if t == thumbnail.template %}selected{% endif %}>{{ t.replace('template_', '').replace('.html', '')|replace('_', ' ')|title }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <button type="submit" class="btn btn-primary btn-small">Swap</button>
                            </form>
                        </div>
                        <div class="thumbnail-controls">
                            <a href="{{ url_for('edit_thumbnail', thumbnail_id=thumbnail.id) }}" class="icon-btn" title="Edit">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                            </a>
                            <form action="{{ url_for('save_to_library', thumbnail_id=thumbnail.id) }}" method="post" style="display: inline;">
                                <button type="submit" class="icon-btn" title="Save to Library">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path></svg>
                                </button>
                            </form>
                             <a href="{{ url_for('social_hub', thumbnail_id=thumbnail.id) }}" class="icon-btn" title="Post to Social Media">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8h1a4 4 0 0 1 0 8h-1"/><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"/><line x1="6" y1="1" x2="6" y2="4"/><line x1="10" y1="1" x2="10" y2="4"/><line x1="14" y1="1" x2="14" y2="4"/></svg>
                            </a>
                            <a href="{{ url_for('generated_file', filename=thumbnail.filename) }}" class="icon-btn" title="Download" download>
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                            </a>
                            <form action="{{ url_for('delete_thumbnail', thumbnail_id=thumbnail.id) }}" method="post" onsubmit="return confirm('Delete this thumbnail?');">
                                <button type="submit" class="icon-btn danger" title="Delete">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <p>No thumbnails generated yet. Upload a CSV file to get started.</p>
        {% endif %}
    </div>

    <style>
        .page-intro { text-align: center; margin-bottom: 2rem; }
        .page-intro h2 { font-size: 2rem; font-weight: 700; margin: 0 0 0.5rem 0; }
        .page-intro p { font-size: 1.1rem; color: var(--text-muted); max-width: 600px; margin: 0 auto; }
        .dashboard-grid { display: grid; grid-template-columns: 1fr; gap: 1.5rem; margin-bottom: 1.5rem; }
        @media (min-width: 768px) { .dashboard-grid { grid-template-columns: 2fr 1fr; } }
        .quick-actions { display: flex; flex-direction: column; gap: 1rem; }

        .inputfile { width: 0.1px; height: 0.1px; opacity: 0; overflow: hidden; position: absolute; z-index: -1; }
        .file-input-container {
            display: flex;
            align-items: center;
            gap: 1rem;
            border: 1px solid var(--border-color);
            background-color: var(--input-bg);
            border-radius: 6px;
            padding: 0.2rem 0.2rem 0.2rem 1rem;
        }
        .file-input-container .btn { flex-shrink: 0; margin: 0; }
        .file-name-display {
            color: var(--text-muted);
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex-grow: 1;
        }
        .form-text { color: var(--text-muted); margin-top: 0.5rem; display: block; font-size: 0.85rem; }
        .form-text a { color: var(--primary-color); text-decoration: none; }
        .form-text a:hover { text-decoration: underline; }
        .gallery-actions { margin-bottom: 1.5rem; display: flex; justify-content: flex-end; }
        .gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 1.5rem;
        }
        .thumbnail-card {
            background-color: var(--card-color);
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid var(--border-color);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .thumbnail-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        .thumbnail-image { border-bottom: 1px solid var(--border-color); }
        .thumbnail-image img { width: 100%; height: auto; display: block; }
        .thumbnail-footer { padding: 0.75rem; }
        .swap-form { margin-bottom: 0.75rem; }
        .swap-form-flex { display: flex; gap: 0.5rem; align-items: center; }
        .swap-form-flex .select-wrapper { flex-grow: 1; }
        .swap-form .select-wrapper select { font-size: 0.85rem; }
        .thumbnail-controls {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 0.5rem;
        }
        .icon-btn {
            background: transparent;
            border: none;
            padding: 0.5rem;
            margin: 0;
            color: var(--text-muted);
            cursor: pointer;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s, color 0.2s;
        }
        .icon-btn:hover { background-color: var(--border-color); color: var(--text-color); }
        .icon-btn.danger:hover { color: var(--error-color); }
        .btn-small { padding: 0.4rem 0.8rem; font-size: 0.8rem; }
    </style>
    <script>
        function updateFileName(input) {
            const fileNameDisplay = document.getElementById('file-name-display');
            if (input.files && input.files.length > 0) {
                fileNameDisplay.textContent = input.files[0].name;
            } else {
                fileNameDisplay.textContent = 'No file chosen';
            }
        }

        // Function to display flash messages (can be moved to base.html if needed globally)
        function displayFlashMessage(message, type) {
            const processPanel = document.getElementById('process-panel');
            if (!processPanel) return;

            const id = ProcessManager.create(message);
            // Simulate success/error after a short delay
            setTimeout(() => {
                ProcessManager.update(id, message, type === 'success');
            }, 500);
        }

        document.addEventListener('DOMContentLoaded', function() {
            const swapForms = document.querySelectorAll('.swap-form-flex');

            swapForms.forEach(form => {
                form.addEventListener('submit', async function(event) {
                    event.preventDefault();

                    const submitButton = form.querySelector('button[type="submit"]');
                    const originalButtonText = submitButton.textContent;
                    submitButton.textContent = 'Swapping...';
                    submitButton.disabled = true;

                    const formData = new FormData(form);
                    const thumbnailId = form.action.split('/').pop();

                    try {
                        const response = await fetch(form.action, {
                            method: 'POST',
                            body: formData
                        });
                        const result = await response.json();

                        if (result.status === 'success') {
                            const thumbnailCard = form.closest('.thumbnail-card');
                            const thumbnailImage = thumbnailCard.querySelector('.thumbnail-image img');
                            thumbnailImage.src = result.new_image_url + '&t=' + new Date().getTime(); // Cache bust
                            displayFlashMessage(result.message, 'success');
                        } else {
                            displayFlashMessage(`Error: ${result.message}`, 'error');
                        }
                    } catch (error) {
                        console.error('Error swapping template:', error);
                        displayFlashMessage('An unexpected error occurred.', 'error');
                    } finally {
                        submitButton.textContent = originalButtonText;
                        submitButton.disabled = false;
                    }
                });
            });

            const imageSpinnerForm = document.querySelector('form[action="{{ url_for('spin_images') }}"]');
            if (imageSpinnerForm) {
                imageSpinnerForm.addEventListener('submit', async function(event) {
                    event.preventDefault();

                    const confirmSpin = confirm('This will randomly change all thumbnail images. Are you sure?');
                    if (!confirmSpin) {
                        return;
                    }

                    const submitButton = imageSpinnerForm.querySelector('button[type="submit"]');
                    const originalButtonText = submitButton.textContent;
                    submitButton.textContent = 'Spinning...';
                    submitButton.disabled = true;

                    try {
                        const response = await fetch(imageSpinnerForm.action, {
                            method: 'POST',
                            body: new FormData(imageSpinnerForm)
                        });
                        const result = await response.json();

                        if (result.status === 'success') {
                            // Reload all thumbnail images to reflect changes
                            document.querySelectorAll('.thumbnail-image img').forEach(img => {
                                img.src = img.src.split('?')[0] + '?v=' + new Date().getTime();
                            });
                            displayFlashMessage(result.message, 'success');
                        } else {
                            displayFlashMessage(`Error: ${result.message}`, 'error');
                        }
                    } catch (error) {
                        console.error('Error spinning images:', error);
                        displayFlashMessage('An unexpected error occurred.', 'error');
                    } finally {
                        submitButton.textContent = originalButtonText;
                        submitButton.disabled = false;
                    }
                });
            }
        });
    </script>
{% endblock %}